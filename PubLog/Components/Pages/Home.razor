@page "/"
@rendermode InteractiveServer
@inject AreaService AreaService
@inject VisitService VisitService
@using System.Security.Claims

<PageTitle>PubLog - Track Your Pub Visits</PageTitle>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-slate-100 mb-2">Areas</h1>
    <input @bind="searchQuery" @bind:event="oninput" placeholder="Search areas..."
           class="input-field max-w-sm" />
</div>

@if (areas is null)
{
    <LoadingSpinner />
}
else
{
    var filtered = FilteredAreas;
    @if (filtered.Count == 0)
    {
        <p class="text-slate-400">No areas found.</p>
    }
    else
    {
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            @foreach (var area in filtered)
            {
                var totalPubs = area.Pubs.Count;
                var visitedCount = isAuthenticated ? area.Pubs.Count(p => visitedPubIds.Contains(p.Id)) : 0;

                <a href="/area/@area.Id" class="card block">
                    <h2 class="text-lg font-semibold text-slate-100">@area.Name</h2>
                    <p class="text-sm text-slate-400 mt-1">
                        @totalPubs pub@(totalPubs != 1 ? "s" : "")
                    </p>
                    @if (isAuthenticated && totalPubs > 0)
                    {
                        <div class="mt-2">
                            <div class="flex items-center justify-between text-xs text-slate-400 mb-1">
                                <span>@visitedCount of @totalPubs visited</span>
                                <span>@(totalPubs > 0 ? (visitedCount * 100 / totalPubs) : 0)%</span>
                            </div>
                            <div class="w-full bg-slate-800 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-blue-400 h-2 rounded-full transition-all"
                                     style="width: @(totalPubs > 0 ? (visitedCount * 100 / totalPubs) : 0)%"></div>
                            </div>
                        </div>
                    }
                </a>
            }
        </div>
    }
}

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = null!;

    private List<Area>? areas;
    private string searchQuery = "";
    private bool isAuthenticated;
    private HashSet<int> visitedPubIds = [];

    private List<Area> FilteredAreas =>
        areas?.Where(a => string.IsNullOrEmpty(searchQuery) ||
                          a.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
              .ToList() ?? [];

    protected override async Task OnInitializedAsync()
    {
        areas = await AreaService.GetAllWithPubCount();

        var auth = await AuthState;
        isAuthenticated = auth.User.Identity?.IsAuthenticated == true;
        if (isAuthenticated)
        {
            var userIdClaim = auth.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userIdClaim is not null)
            {
                visitedPubIds = await VisitService.GetVisitedPubIds(int.Parse(userIdClaim));
            }
        }
    }
}
