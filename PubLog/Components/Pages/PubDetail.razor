@page "/pub/{Id:int}"
@rendermode InteractiveServer
@inject PubService PubService
@inject VisitService VisitService
@inject NavigationManager Navigation
@using System.Security.Claims

<PageTitle>@(pub?.Name ?? "Pub") - PubLog</PageTitle>

@if (pub is null)
{
    <LoadingSpinner />
}
else
{
    <div class="mb-4">
        <a href="/area/@pub.AreaId" class="text-blue-400 hover:text-blue-300 text-sm">&larr; @pub.Area.Name</a>
    </div>

    <h1 class="text-2xl font-bold text-slate-100 mb-2">@pub.Name</h1>

    @if (!string.IsNullOrWhiteSpace(pub.Address))
    {
        <p class="text-slate-400 mb-4">@pub.Address</p>
    }

    @if (userVisit is not null)
    {
        <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg px-4 py-3 mb-4 flex items-center justify-between">
            <span class="text-emerald-400 text-sm">
                You visited on @userVisit.VisitDate.ToString("d MMM yyyy")
            </span>
            <a href="/pub/@Id/visit" class="text-blue-400 hover:text-blue-300 text-sm font-medium">Update Visit</a>
        </div>
    }
    else if (isAuthenticated)
    {
        <div class="mb-4">
            <a href="/pub/@Id/visit" class="btn-primary">Mark as Visited</a>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(pub.ImageUrl))
    {
        <img src="@pub.ImageUrl" alt="@pub.Name" class="w-full max-w-lg rounded-xl mb-4 object-cover max-h-64" />
    }

    @if (!string.IsNullOrWhiteSpace(pub.Description))
    {
        <p class="text-slate-300 mb-6">@pub.Description</p>
    }

    <div class="mb-6">
        <LeafletMap CenterLat="pub.Lat" CenterLng="pub.Lng" Zoom="16" Height="300px"
                    Markers="GetMarkers()" />
    </div>

    <div class="flex flex-wrap gap-3 mb-6">
        <a href="@(!string.IsNullOrWhiteSpace(pub.GooglePlaceId) ? $"https://www.google.com/maps/place/?q=place_id:{pub.GooglePlaceId}" : $"https://www.google.com/maps/search/?api=1&query={pub.Lat},{pub.Lng}")"
           target="_blank" rel="noopener" class="btn-secondary !text-sm">
            Google Maps
        </a>
        <a href="@(!string.IsNullOrWhiteSpace(pub.TripAdvisorUrl) ? pub.TripAdvisorUrl : $"https://www.tripadvisor.com/Search?q={Uri.EscapeDataString(pub.Name + " " + pub.Address)}")"
           target="_blank" rel="noopener" class="btn-secondary !text-sm">
            TripAdvisor
        </a>
    </div>

    @if (pub.Visits.Count > 0)
    {
        <h2 class="text-lg font-semibold text-slate-100 mb-3">Visits (@pub.Visits.Count)</h2>
        <div class="space-y-2">
            @foreach (var visit in pub.Visits.OrderByDescending(v => v.VisitDate))
            {
                <div class="card">
                    <div class="flex items-center justify-between">
                        <span class="font-medium text-slate-200">@visit.User.DisplayName</span>
                        <span class="text-sm text-slate-400">@visit.VisitDate.ToString("d MMM yyyy")</span>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(visit.Notes))
                    {
                        <p class="text-sm text-slate-400 mt-1">@visit.Notes</p>
                    }
                </div>
            }
        </div>
    }
}

@code {
    [Parameter] public int Id { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = null!;

    private Pub? pub;
    private Visit? userVisit;
    private bool isAuthenticated;

    private List<MapMarker> GetMarkers()
    {
        if (pub is null) return [];
        return [new MapMarker(pub.Lat, pub.Lng, $"<b>{pub.Name}</b>")];
    }

    protected override async Task OnInitializedAsync()
    {
        pub = await PubService.GetById(Id);
        if (pub is null)
        {
            Navigation.NavigateTo("/");
            return;
        }

        var auth = await AuthState;
        isAuthenticated = auth.User.Identity?.IsAuthenticated == true;
        if (isAuthenticated)
        {
            var userIdClaim = auth.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (userIdClaim is not null)
            {
                userVisit = await VisitService.GetByUserAndPub(int.Parse(userIdClaim), Id);
            }
        }
    }
}
