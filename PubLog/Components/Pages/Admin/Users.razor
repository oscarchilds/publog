@page "/admin/users"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject UserService UserService

<PageTitle>Manage Users - PubLog</PageTitle>

<AdminNav />

<h1 class="text-2xl font-bold text-amber-900 mb-6">Users</h1>

<div class="card mb-6">
    <h2 class="text-lg font-semibold text-amber-800 mb-3">Create User</h2>
    <EditForm Model="newUser" OnValidSubmit="CreateUser" FormName="CreateUserForm" class="space-y-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <InputText @bind-Value="newUser.Username" class="input-field" placeholder="Username" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <InputText @bind-Value="newUser.Password" type="password" class="input-field" placeholder="Password" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
                <InputText @bind-Value="newUser.DisplayName" class="input-field" placeholder="Display Name" />
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                <InputSelect @bind-Value="newUser.Role" class="input-field">
                    <option value="@UserRole.User">User</option>
                    <option value="@UserRole.Admin">Admin</option>
                </InputSelect>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p class="text-red-600 text-sm">@errorMessage</p>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <p class="text-green-600 text-sm">@successMessage</p>
        }

        <button type="submit" class="btn-primary">Create User</button>
    </EditForm>
</div>

@if (users is null)
{
    <p class="text-gray-500">Loading...</p>
}
else
{
    <div class="space-y-2">
        @foreach (var user in users)
        {
            <div class="card flex items-center justify-between">
                <div>
                    <span class="font-medium text-gray-800">@user.DisplayName</span>
                    <span class="text-sm text-gray-500 ml-2">@@@user.Username</span>
                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full @(user.Role == UserRole.Admin ? "bg-amber-100 text-amber-800" : "bg-gray-100 text-gray-600")">
                        @user.Role
                    </span>
                    @if (!user.IsActive)
                    {
                        <span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-red-100 text-red-700">Inactive</span>
                    }
                </div>
                <button @onclick="() => ToggleActive(user.Id)"
                        class="btn-secondary !py-1 !text-xs @(user.IsActive ? "!text-red-600" : "!text-green-600")">
                    @(user.IsActive ? "Deactivate" : "Activate")
                </button>
            </div>
        }
    </div>
}

@code {
    private List<User>? users;
    private string? errorMessage;
    private string? successMessage;
    private CreateUserModel newUser = new();

    private class CreateUserModel
    {
        public string Username { get; set; } = "";
        public string Password { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public UserRole Role { get; set; } = UserRole.User;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        users = await UserService.GetAll();
    }

    private async Task CreateUser()
    {
        errorMessage = null;
        successMessage = null;

        if (string.IsNullOrWhiteSpace(newUser.Username) || string.IsNullOrWhiteSpace(newUser.Password) ||
            string.IsNullOrWhiteSpace(newUser.DisplayName))
        {
            errorMessage = "All fields are required.";
            return;
        }

        if (await UserService.UsernameExists(newUser.Username))
        {
            errorMessage = "Username already exists.";
            return;
        }

        await UserService.CreateUser(newUser.Username, newUser.Password, newUser.DisplayName, newUser.Role);
        successMessage = $"User '{newUser.Username}' created successfully.";
        newUser = new();
        await LoadUsers();
    }

    private async Task ToggleActive(int userId)
    {
        await UserService.ToggleActive(userId);
        await LoadUsers();
    }
}
