@page "/admin/users"
@rendermode InteractiveServer
@attribute [Authorize(Roles = "Admin")]
@inject UserService UserService

<PageTitle>Manage Users - PubLog</PageTitle>

<AdminNav />

<h1 class="text-2xl font-bold text-slate-100 mb-6">Users</h1>

<div class="card mb-6">
    <h2 class="text-lg font-semibold text-slate-100 mb-3">Create User</h2>
    <EditForm Model="newUser" OnValidSubmit="CreateUser" FormName="CreateUserForm" class="space-y-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1">Username</label>
                <InputText @bind-Value="newUser.Username" class="input-field" placeholder="Username" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1">Password</label>
                <InputText @bind-Value="newUser.Password" type="password" class="input-field" placeholder="Password" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1">Display Name</label>
                <InputText @bind-Value="newUser.DisplayName" class="input-field" placeholder="Display Name" />
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1">Role</label>
                <InputSelect @bind-Value="newUser.Role" class="input-field">
                    <option value="@UserRole.User">User</option>
                    <option value="@UserRole.Admin">Admin</option>
                </InputSelect>
            </div>
        </div>

        <AlertMessage Message="@errorMessage" IsError="true" />
        <AlertMessage Message="@successMessage" />

        <button type="submit" class="btn-primary" disabled="@creating">
            @(creating ? "Creating..." : "Create User")
        </button>
    </EditForm>
</div>

@if (users is null)
{
    <LoadingSpinner />
}
else
{
    <div class="space-y-2">
        @foreach (var user in users)
        {
            <div class="card flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div class="flex flex-wrap items-center gap-1">
                    <span class="font-medium text-slate-100">@user.DisplayName</span>
                    <span class="text-sm text-slate-400 ml-1">@@@user.Username</span>
                    <span class="ml-1 text-xs px-2 py-0.5 rounded-full @(user.Role == UserRole.Admin ? "bg-blue-500/20 text-blue-400" : "bg-slate-700 text-slate-300")">
                        @user.Role
                    </span>
                    @if (!user.IsActive)
                    {
                        <span class="ml-1 text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400">Inactive</span>
                    }
                </div>
                <button @onclick="() => PromptToggle(user)"
                        class="btn-secondary !py-1 !text-xs @(user.IsActive ? "!text-red-400" : "!text-emerald-400") self-start sm:self-auto">
                    @(user.IsActive ? "Deactivate" : "Activate")
                </button>
            </div>
        }
    </div>
}

<ConfirmDialog Visible="pendingToggleUser is not null"
               Title="@(pendingToggleUser?.IsActive == true ? "Deactivate User" : "Activate User")"
               Message="@($"Are you sure you want to {(pendingToggleUser?.IsActive == true ? "deactivate" : "activate")} '{pendingToggleUser?.DisplayName}'?")"
               OnConfirm="ConfirmToggle"
               OnCancel="() => pendingToggleUser = null" />

@code {
    private List<User>? users;
    private string? errorMessage;
    private string? successMessage;
    private bool creating;
    private User? pendingToggleUser;
    private CreateUserModel newUser = new();

    private class CreateUserModel
    {
        public string Username { get; set; } = "";
        public string Password { get; set; } = "";
        public string DisplayName { get; set; } = "";
        public UserRole Role { get; set; } = UserRole.User;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        users = await UserService.GetAll();
    }

    private async Task CreateUser()
    {
        errorMessage = null;
        successMessage = null;

        if (string.IsNullOrWhiteSpace(newUser.Username) || string.IsNullOrWhiteSpace(newUser.Password) ||
            string.IsNullOrWhiteSpace(newUser.DisplayName))
        {
            errorMessage = "All fields are required.";
            return;
        }

        if (await UserService.UsernameExists(newUser.Username))
        {
            errorMessage = "Username already exists.";
            return;
        }

        creating = true;
        await UserService.CreateUser(newUser.Username, newUser.Password, newUser.DisplayName, newUser.Role);
        successMessage = $"User '{newUser.Username}' created successfully.";
        newUser = new();
        creating = false;
        await LoadUsers();
    }

    private void PromptToggle(User user) => pendingToggleUser = user;

    private async Task ConfirmToggle()
    {
        if (pendingToggleUser is null) return;
        await UserService.ToggleActive(pendingToggleUser.Id);
        pendingToggleUser = null;
        await LoadUsers();
    }
}
