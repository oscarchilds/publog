@page "/login"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using PubLog.Services

<PageTitle>Login - PubLog</PageTitle>

<div class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-sm">
        <h1 class="text-2xl font-bold text-slate-100 mb-6 text-center">Sign In</h1>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded mb-4">
                @errorMessage
            </div>
        }

        <form method="post" @formname="login">
            <AntiforgeryToken />
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-slate-300 mb-1">Username</label>
                <input type="text" id="username" name="username" required autocomplete="username"
                       class="input-field" />
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-slate-300 mb-1">Password</label>
                <input type="password" id="password" name="password" required autocomplete="current-password"
                       class="input-field" />
            </div>
            <button type="submit" class="btn-primary w-full">Sign In</button>
        </form>
    </div>
</div>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = null!;

    private string? errorMessage;

    [SupplyParameterFromForm]
    private string? Username { get; set; }

    [SupplyParameterFromForm]
    private string? Password { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (HttpMethods.IsPost(HttpContext.Request.Method))
        {
            await HandleLogin();
        }
    }

    private async Task HandleLogin()
    {
        if (string.IsNullOrWhiteSpace(Username) || string.IsNullOrWhiteSpace(Password))
        {
            errorMessage = "Please enter both username and password.";
            return;
        }

        var authService = HttpContext.RequestServices.GetRequiredService<AuthService>();
        var user = await authService.ValidateCredentials(Username, Password);

        if (user is null)
        {
            errorMessage = "Invalid username or password.";
            return;
        }

        var principal = authService.CreateClaimsPrincipal(user);
        await HttpContext.SignInAsync(CookieAuthenticationDefaults.AuthenticationScheme, principal);
        HttpContext.Response.Redirect("/");
    }
}
