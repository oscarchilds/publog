@page "/pub/{PubId:int}/visit"
@rendermode InteractiveServer
@attribute [Authorize]
@inject VisitService VisitService
@inject PubService PubService
@inject NavigationManager Navigation
@using System.Security.Claims

<PageTitle>@(isEdit ? "Update Visit" : "Mark as Visited") - PubLog</PageTitle>

@if (pub is null)
{
    <LoadingSpinner />
}
else
{
    <div class="mb-4">
        <a href="/pub/@PubId" class="text-amber-600 hover:text-amber-800 text-sm">&larr; @pub.Name</a>
    </div>

    <h1 class="text-2xl font-bold text-amber-900 mb-6">
        @(isEdit ? "Update Visit" : "Mark as Visited") â€” @pub.Name
    </h1>

    <EditForm Model="model" OnValidSubmit="Save" FormName="VisitForm" class="space-y-4 max-w-lg">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Visit Date</label>
            <InputDate @bind-Value="model.VisitDate" class="input-field" />
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
            <InputTextArea @bind-Value="model.Notes" class="input-field" rows="4"
                           placeholder="How was your visit?" />
        </div>

        <div class="flex gap-3">
            <button type="submit" class="btn-primary" disabled="@saving">
                @(saving ? "Saving..." : "Save")
            </button>
            @if (isEdit)
            {
                <button type="button" @onclick="ShowDeleteConfirm" class="btn-secondary !text-red-600 !border-red-300 hover:!bg-red-50">
                    Delete Visit
                </button>
            }
            <a href="/pub/@PubId" class="btn-secondary">Cancel</a>
        </div>
    </EditForm>

    <ConfirmDialog Visible="showDeleteConfirm"
                   Title="Delete Visit"
                   Message="Are you sure you want to delete this visit? This cannot be undone."
                   OnConfirm="ConfirmDelete"
                   OnCancel="() => showDeleteConfirm = false" />
}

@code {
    [Parameter] public int PubId { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = null!;

    private Pub? pub;
    private Visit? existingVisit;
    private bool isEdit;
    private bool saving;
    private bool showDeleteConfirm;
    private VisitModel model = new();
    private int userId;

    private class VisitModel
    {
        public DateTime VisitDate { get; set; } = DateTime.Today;
        public string? Notes { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var auth = await AuthState;
        var userIdClaim = auth.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (userIdClaim is null)
        {
            Navigation.NavigateTo("/login");
            return;
        }
        userId = int.Parse(userIdClaim);

        pub = await PubService.GetById(PubId);
        if (pub is null)
        {
            Navigation.NavigateTo("/");
            return;
        }

        existingVisit = await VisitService.GetByUserAndPub(userId, PubId);
        if (existingVisit is not null)
        {
            isEdit = true;
            model.VisitDate = existingVisit.VisitDate;
            model.Notes = existingVisit.Notes;
        }
    }

    private async Task Save()
    {
        saving = true;

        if (isEdit && existingVisit is not null)
        {
            existingVisit.VisitDate = model.VisitDate;
            existingVisit.Notes = model.Notes;
            await VisitService.Update(existingVisit);
        }
        else
        {
            var visit = new Visit
            {
                UserId = userId,
                PubId = PubId,
                VisitDate = model.VisitDate,
                Notes = model.Notes
            };
            await VisitService.Create(visit);
        }
        Navigation.NavigateTo($"/pub/{PubId}");
    }

    private void ShowDeleteConfirm() => showDeleteConfirm = true;

    private async Task ConfirmDelete()
    {
        showDeleteConfirm = false;
        if (existingVisit is not null)
        {
            await VisitService.Delete(existingVisit.Id);
        }
        Navigation.NavigateTo($"/pub/{PubId}");
    }
}
